<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>RaspadinhaKanpary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg:#0b0f1a; --card:#121725; --panel:#111626cc; --accent:#7c4dff;
      --accent2:#21c17a; --text:#e6e6e6; --muted:#a9b0bd; --danger:#e74c3c;
      --glass:rgba(255,255,255,0.06); --border:#2a2f3a;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 20px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #0f1218; color: var(--text);
    }
    .card {
      background: #181c25;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    input, textarea {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #0f1218;
      color: var(--text);
    }
    button {
      margin-top: 6px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { opacity: 0.9 }
    .btn-primary { background: #2d6cdf; color: #fff }
    .btn-success { background: #21c17a; color: #fff }
    .btn-danger { background: var(--danger); color: #fff }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 6px;
      text-align: center;
    }
    th { background: #222 }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: conic-gradient(from 220deg at 50% 50%, #7c4dff, #21c17a, #ffd76d, #7c4dff);
      box-shadow: 0 0 16px #7c4dff33;
    }
    .title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .3px;
    }
    .tag {
      background: #ffffff10;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ffffff14;
      color: #b8c1d1;
      font-size: 13px;
    }
    .balance {
      font-weight: 700;
      color: #dfe6f3;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .hidden { display: none }
  </style>
</head>
<body>
  <div class="brand">
    <div class="logo"></div>
    <div class="title">RaspadinhaKanpary</div>
  </div>

  <!-- Cadastro -->
  <div class="card" id="registerPanel">
    <h3>Cadastro</h3>
    <input id="regUsername" type="text" placeholder="Nome de usuário">
    <input id="regEmail" type="email" placeholder="E-mail">
    <input id="regPassword" type="password" placeholder="Senha">
    <input id="regCpf" type="text" placeholder="CPF">
    <button class="btn-success" onclick="register()">Cadastrar</button>
    <div id="regResult"></div>
  </div>

  <!-- Login -->
  <div class="card" id="loginPanel">
    <h3>Login</h3>
    <input id="loginEmail" type="email" placeholder="E-mail">
    <input id="loginPassword" type="password" placeholder="Senha">
    <button class="btn-primary" onclick="login()">Entrar</button>
    <div id="loginResult"></div>
  </div>

  <!-- Perfil -->
  <div class="card hidden" id="profilePanel">
    <h3>Perfil</h3>
    <div id="profileInfo"></div>
    <div class="actions">
      <button class="btn-success" onclick="showPanel('depositPanel')">Depositar</button>
      <button class="btn-danger" onclick="showPanel('withdrawPanel')">Sacar</button>
      <button class="btn" onclick="loadTransactions()">Histórico</button>
      <button class="btn-primary" onclick="showPanel('scratchPanel')">Raspadinha</button>
    </div>
  </div>

  <!-- Painel de depósito -->
  <div class="card hidden" id="depositPanel">
    <h3>Depósito</h3>
    <input id="depAmount" type="number" value="10" min="6" step="0.01">
    <input id="depDocument" type="text" placeholder="CPF ou CNPJ do comprador">
    <button class="btn-success" onclick="deposit()">Depositar</button>
    <div id="dep"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Painel de saque -->
  <div class="card hidden" id="withdrawPanel">
    <h3>Saque</h3>
    <input id="saqAmount" type="number" value="20" min="10" max="500" step="0.01">
    <select id="pixType">
      <option value="cpf">CPF</option>
      <option value="cnpj">CNPJ</option>
      <option value="email">E-mail</option>
      <option value="phone">Telefone</option>
      <option value="random">Chave Aleatória</option>
    </select>
    <input id="pixKey" placeholder="Informe a chave Pix">
    <button class="btn-danger" onclick="withdraw()">Sacar</button>
    <div id="saq"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Histórico -->
  <div class="card hidden" id="historyPanel">
    <h3>Histórico de Transações</h3>
    <table>
      <thead>
        <tr><th>Data</th><th>Tipo</th><th>Valor</th><th>Saldo após</th></tr>
      </thead>
      <tbody id="txBody">
        <tr><td colspan="4">Sem transações</td></tr>
      </tbody>
    </table>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Raspadinha -->
  <div class="card hidden" id="scratchPanel">
    <h3>Raspadinha</h3>
    <div class="scratch-content" id="content">
      <div class="tag">Seu prêmio</div>
      <div class="prize" id="prizeText">R$ 0,00</div>
      <div class="sub" id="prizeLabel">Clique em “Raspar agora”</div>
    </div>

    <div style="margin-top:8px">
      <label>Aposta:
        <input id="betAmount" type="number" value="1.00" min="0.2" max="30" step="0.01" style="width:100px">
      </label>
    </div>

    <div class="actions">
      <span class="tag">Saldo: <span class="balance" id="balance">R$ 0,00</span></span>
      <button class="btn-primary" onclick="playScratch()">Raspar agora</button>
      <button class="btn" onclick="resetScratch()">Raspar de novo</button>
    </div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Scripts -->
  <script>
    const API = 'https://kanparycasino.onrender.com';
    let userId = null;
    let userEmail = null;

    // utilitário
    const fmt = v => (typeof v === 'number')
      ? v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' })
      : v;

    // exibir painéis
    function showPanel(id) {
      ['registerPanel','loginPanel','profilePanel','depositPanel','withdrawPanel','historyPanel','scratchPanel']
        .forEach(p => document.getElementById(p).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    // cadastro
    async function register() {
      const username = document.getElementById('regUsername').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const password = document.getElementById('regPassword').value.trim();
      const cpf = document.getElementById('regCpf').value.trim();

      if (!username || !email || !password || !cpf) return alert('Preencha todos os campos');

      try {
        const r = await fetch(`${API}/register`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ username, email, password, cpf })
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro no cadastro');

        alert('Cadastro realizado com sucesso!');
        showPanel('loginPanel');
      } catch (err) {
        console.error(err);
        alert('Erro de rede ao cadastrar');
      }
    }

    // login
    async function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!email || !password) return alert('Informe e-mail e senha');

      try {
        const r = await fetch(`${API}/login`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro no login');

        userId = j.userId;
        userEmail = j.email;
        document.getElementById('profileInfo').innerText = `Logado como ${userEmail}`;
        wallet();
        showPanel('profilePanel');
      } catch (err) {
        console.error(err);
        alert('Erro de rede ao efetuar login');
      }
    }

    // carteira
    async function wallet() {
      if (!userId) return;
      try {
        const r = await fetch(`${API}/wallet/${userId}`);
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro ao buscar carteira');

        document.getElementById('balance').innerText = fmt(j.balance || 0);
      } catch (err) {
        console.error(err);
        alert('Erro de rede ao buscar carteira');
      }
    }

    // depósito
    async function deposit() {
      if (!userId) return alert('Faça login');
      const reais = Number(document.getElementById('depAmount').value);
      const documento = document.getElementById('depDocument').value.trim();

      if (!reais || reais < 6) return alert('Valor mínimo é R$ 6,00');
      if (!documento) return alert('Informe CPF ou CNPJ');

      try {
        const r = await fetch(`${API}/deposit`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId, amount: reais, currency:'BRL', buyer_document: documento })
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro no depósito');

        let html = `<p><b>Status:</b> ${j.status || 'pending'}</p>`;
        if (j.pixCopiaCola) {
          html += `
            <p><b>Copia e Cola:</b></p>
            <textarea readonly style="width:100%;height:80px">${j.pixCopiaCola}</textarea>
          `;
        }
        if (j.checkoutUrl) {
          html += `<p><a href="${j.checkoutUrl}" target="_blank">Abrir checkout</a></p>`;
        }

        document.getElementById('dep').innerHTML = html;

        // Redireciona para raspadinha
        setTimeout(() => {
          wallet();
          loadTransactions();
          showPanel('scratchPanel');
        }, 3000);
      } catch (err) {
        console.error(err);
        alert('Erro de rede ao criar depósito');
      }
    }

    // saque
    async function withdraw() {
      if (!userId) return alert('Faça login');
      let reais = Number(document.getElementById('saqAmount').value);
      const pixType = document.getElementById('pixType').value;
      const pixKey = document.getElementById('pixKey').value.trim();

      if (!reais || reais < 10) return alert('Valor mínimo é R$ 10,00');
      if (reais > 500) return alert('Valor máximo é R$ 500,00');
      if (!pixKey) return alert('Informe a chave Pix');

      const taxa = reais * 0.03;
      const valorLiquido = reais - taxa;

      try {
        const r = await fetch(`${API}/payout`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            userId, amount: reais, currency:'BRL',
            destination: { type: pixType, key: pixKey }
          })
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro no saque');

        document.getElementById('saq').innerText =
          `Solicitado: ${fmt(reais)} | Taxa: ${fmt(taxa)} | Líquido: ${fmt(valorLiquido)} → Status: ${j.status}`;
        wallet();
        loadTransactions();
      } catch (err) {
        console.error(err);
        alert('Erro de rede ao solicitar saque');
      }
    }

    // histórico
    async function loadTransactions() {
      if (!userId) return;
      try {
        const r = await fetch(`${API}/transactions/${userId}`);
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro ao buscar histórico');

        const rows = (j.items || []).map(tx => `
          <tr>
            <td>${new Date(tx.created_at).toLocaleString('pt-BR')}</td>
            <td>${tx.type}</td>
            <td>${fmt(tx.amount)}</td>
            <td>${fmt(tx.balance_after)}</td>
          </tr>
        `).join('');

        document.getElementById('txBody').innerHTML = rows || '<tr><td colspan="4">Sem transações</td></tr>';
        showPanel('historyPanel');
      } catch (err) {
        console.error(err);
        alert('Erro ao carregar transações');
      }
    }

    // raspadinha
    async function playScratch() {
      if (!userId) return alert('Faça login');
      const aposta = Number(document.getElementById('betAmount').value);
      if (!aposta || aposta < 0.2 || aposta > 30) return alert('Aposta entre R$ 0,20 e R$ 30,00');

      try {
        const r = await fetch(`${API}/scratch/play`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId, bet: aposta })
        });
        const j = await r.json();
        if (!r.ok) return alert(j.error || 'Erro na raspadinha');

        document.getElementById('prizeText').innerText = fmt(j.prize || 0);
        document.getElementById('prizeLabel').innerText = '';
        document.getElementById('balance').innerText = fmt(j.finalBalance || 0);
        wallet();
        loadTransactions();
      } catch (err) {
        console.error(err);
        alert('Erro de rede ao jogar raspadinha');
      }
    }

    function resetScratch() {
      document.getElementById('prizeText').innerText = 'R$ 0,00';
      document.getElementById('prizeLabel').innerText = 'Clique em “Raspar agora”';
    }
  </script>
</body>
</html>
