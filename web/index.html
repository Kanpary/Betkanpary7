<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>RaspadinhaKanpary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg:#0b0f1a; --card:#121725; --panel:#111626cc; --accent:#7c4dff;
      --accent2:#21c17a; --text:#e6e6e6; --muted:#a9b0bd; --danger:#e74c3c;
      --glass:rgba(255,255,255,0.06); --border:#2a2f3a;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 20px;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: #0f1218; color: var(--text);
    }
    .card {
      background: #181c25;
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    input, textarea, select {
      width: 100%;
      margin-bottom: 6px;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: #0f1218;
      color: var(--text);
    }
    button {
      margin-top: 6px;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { opacity: 0.9 }
    .btn-primary { background: #2d6cdf; color: #fff }
    .btn-success { background: #21c17a; color: #fff }
    .btn-danger { background: var(--danger); color: #fff }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid var(--border);
      padding: 6px;
      text-align: center;
    }
    th { background: #222 }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: conic-gradient(from 220deg at 50% 50%, #7c4dff, #21c17a, #ffd76d, #7c4dff);
      box-shadow: 0 0 16px #7c4dff33;
    }
    .title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: .3px;
    }
    .tag {
      background: #ffffff10;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #ffffff14;
      color: #b8c1d1;
      font-size: 13px;
    }
    .balance {
      font-weight: 700;
      color: #dfe6f3;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .hidden { display: none }
  </style>
</head>
<body>
  <div class="brand">
    <div class="logo"></div>
    <div class="title">RaspadinhaKanpary</div>
  </div>

  <!-- Cadastro -->
  <div class="card" id="registerPanel">
    <h3>Cadastro</h3>
    <input id="regUsername" type="text" placeholder="Nome de usuário">
    <input id="regEmail" type="email" placeholder="E-mail">
    <input id="regPassword" type="password" placeholder="Senha">
    <input id="regCpf" type="text" placeholder="CPF">
    <button class="btn-success" onclick="register()">Cadastrar</button>
    <div id="regResult"></div>
  </div>

  <!-- Login -->
  <div class="card" id="loginPanel">
    <h3>Login</h3>
    <input id="loginEmail" type="email" placeholder="E-mail">
    <input id="loginPassword" type="password" placeholder="Senha">
    <button class="btn-primary" onclick="login()">Entrar</button>
    <div id="loginResult"></div>
  </div>

  <!-- Perfil -->
  <div class="card hidden" id="profilePanel">
    <h3>Perfil</h3>
    <div id="profileInfo"></div>
    <div class="actions">
      <button class="btn-success" onclick="showPanel('depositPanel')">Depositar</button>
      <button class="btn-danger" onclick="showPanel('withdrawPanel')">Sacar</button>
      <button class="btn" onclick="loadTransactions()">Histórico</button>
      <button class="btn-primary" onclick="showPanel('scratchPanel')">Raspadinha</button>
    </div>
  </div>

  <!-- Painel de depósito -->
  <div class="card hidden" id="depositPanel">
    <h3>Depósito</h3>
    <input id="depAmount" type="number" value="10" min="6" step="0.01">
    <button class="btn-success" onclick="deposit()">Depositar</button>
    <div id="dep"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Painel de saque -->
  <div class="card hidden" id="withdrawPanel">
    <h3>Saque</h3>
    <input id="saqAmount" type="number" value="20" min="10" max="500" step="0.01">
    <select id="pixType">
      <option value="cpf">CPF</option>
      <option value="cnpj">CNPJ</option>
      <option value="email">E-mail</option>
      <option value="phone">Telefone</option>
      <option value="random">Chave Aleatória</option>
    </select>
    <input id="pixKey" placeholder="Informe a chave Pix">
    <button class="btn-danger" onclick="withdraw()">Sacar</button>
    <div id="saq"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Painel de raspadinha -->
  <div class="card hidden" id="scratchPanel">
    <h3>Raspadinha</h3>
    <input id="scratchBet" type="number" value="5" min="1" step="0.01">
    <button class="btn-primary" onclick="playScratch()">Jogar</button>
    <div id="scratchResult"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Painel de histórico -->
  <div class="card hidden" id="transactionsPanel">
    <h3>Histórico de Transações</h3>
    <div id="transactions"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <!-- Painel BullsPay -->
  <div class="card hidden" id="bullspayPanel">
    <h3>Integração BullsPay</h3>
    <div class="actions">
      <button class="btn" onclick="loadBullsTransactions()">Transações BullsPay</button>
      <button class="btn" onclick="loadBullsBalance()">Saldo BullsPay</button>
      <button class="btn" onclick="loadBullsWithdrawals()">Saques BullsPay</button>
    </div>
    <div id="bullsResult"></div>
    <button onclick="showPanel('profilePanel')">⬅️ Voltar</button>
  </div>

  <script>
    let currentUser = null;

    function showPanel(id) {
      document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    async function register() {
      const username = regUsername.value;
      const email = regEmail.value;
      const password = regPassword.value;
      const cpf = regCpf.value;
      const res = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ username, email, password, cpf })
      });
      const data = await res.json();
      regResult.innerText = JSON.stringify(data);
    }

    async function login() {
      const email = loginEmail.value;
      const password = loginPassword.value;
      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (data.userId) {
        currentUser = data;
        profileInfo.innerText = `Usuário: ${data.email} (ID: ${data.userId})`;
        showPanel('profilePanel');
      } else {
        loginResult.innerText = data.error || 'Erro no login';
      }
    }

    async function deposit() {
      const amount = depAmount.value;
      const res = await fetch('/deposit', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ userId: currentUser.userId, amount })
      });
      const data = await res.json();
      dep.innerText = JSON.stringify(data, null, 2);
    }

    async function withdraw() {
      const amount = saqAmount.value;
      const destination = { type: pixType.value, key: pixKey.value };
      const res = await fetch('/payout', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ userId: currentUser.userId, amount, destination })
      });
      const data = await res.json();
      saq.innerText = JSON.stringify(data, null, 2);
    }

    async function loadTransactions() {
      const res = await fetch(`/transactions/${currentUser.userId}`);
      const data = await res.json();
      let html = '<table><tr><th>ID</th><th>Tipo</th><th>Valor</th><th>Status</th><th>Saldo</th></tr>';
      data.items.forEach(tx => {
        html += `<tr><td>${tx.id}</td><td>${tx.type}</td><td>${tx.amount}</td><td>${tx.status}</td><td>${tx.balance_after}</td></tr>`;
      });
      html += '</table>';
      transactions.innerHTML = html;
      showPanel('transactionsPanel');
    }

    async function playScratch() {
      const bet = scratchBet.value;
      const res = await fetch('/scratch/play', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ userId: currentUser.userId, bet })
      });
      const data = await res.json();
      scratchResult.innerText = `Prêmio: ${data.prize} | Saldo final: ${data.finalBalance}`;
    }

    // BullsPay integrações reais
    async function loadBullsTransactions() {
      const res = await fetch('/bullspay/transactions');
      const data = await res.json();
      bullsResult.innerText = JSON.stringify(data, null, 2);
      showPanel('bullspayPanel');
    }

    async function loadBullsBalance() {
      const res = await fetch('/bullspay/balance');
      const data = await res.json();
      bullsResult.innerText = JSON.stringify(data, null, 2);
      showPanel('bullspayPanel');
    }

    async function loadBullsWithdrawals() {
      const res = await fetch('/bullspay/withdrawals');
      const data = await res.json();
      bullsResult.innerText = JSON.stringify(data, null, 2);
      showPanel('bullspayPanel');
    }
  </script>
</body>
</html>
