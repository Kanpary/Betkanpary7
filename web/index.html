<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>FXPay Cassino</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 20px; background:#0f1218; color:#e6e6e6 }
    .card { background:#181c25; border:1px solid #2a2f3a; padding: 12px; border-radius: 8px; margin-bottom: 12px }
    textarea { width: 100%; }
    button { margin-top: 6px; padding:6px 12px; border:none; border-radius:4px; cursor:pointer }
    button:hover { opacity:0.9 }
    .btn-primary { background:#2d6cdf; color:#fff }
    .btn-success { background:#21c17a; color:#fff }
    .btn-danger { background:#e74c3c; color:#fff }
    table { width:100%; border-collapse: collapse; margin-top:10px }
    th, td { border:1px solid #2a2f3a; padding:6px; text-align:center }
    th { background:#222; }
  </style>
</head>
<body>
  <h1>FXPay Cassino</h1>

  <div class="card">
    <input id="email" placeholder="Seu e-mail">
    <button class="btn-primary" onclick="login()">Entrar</button>
    <div id="user"></div>
  </div>

  <div class="card">
    <button class="btn-success" onclick="wallet()">Atualizar carteira</button>
    <div id="wallet"></div>
  </div>

  <div class="card">
    <h3>Depósito</h3>
    <input id="depAmount" type="number" value="10" min="6" step="0.01">
    <button class="btn-success" onclick="deposit()">Depositar</button>
    <div id="dep"></div>
  </div>

  <div class="card">
    <h3>Saque</h3>
    <input id="saqAmount" type="number" value="20">
    <select id="pixType">
      <option value="cpf">CPF</option>
      <option value="cnpj">CNPJ</option>
      <option value="email">E-mail</option>
      <option value="phone">Telefone</option>
      <option value="random">Chave Aleatória</option>
    </select>
    <input id="pixKey" placeholder="Informe a chave Pix">
    <button class="btn-danger" onclick="withdraw()">Sacar</button>
    <div id="saq"></div>
  </div>

  <div class="card">
    <h3>Roleta</h3>
    <input id="betAmount" type="number" value="5">
    <select id="betType">
      <option value="color">Cor</option>
      <option value="number">Número</option>
    </select>
    <input id="betValue" placeholder="red/black/green ou 0-36" value="red">
    <button class="btn-primary" onclick="bet()">Apostar</button>
    <div id="bet"></div>
  </div>

  <div class="card">
    <h3>Histórico de Transações</h3>
    <button class="btn-primary" onclick="loadTransactions()">Carregar histórico</button>
    <table>
      <thead>
        <tr><th>Data</th><th>Tipo</th><th>Valor</th><th>Saldo após</th></tr>
      </thead>
      <tbody id="txBody"></tbody>
    </table>
  </div>

  <script>
const API = 'https://kanparycasino.onrender.com'; // URL do backend

let userId = null;
let userEmail = null;

async function login() {
  const email = document.getElementById('email').value.trim();
  if (!email) return alert('Informe seu e-mail');

  const r = await fetch(`${API}/login`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email })
  });

  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Erro no login');

  userId = j.userId;
  userEmail = j.email;
  document.getElementById('user').innerText = `User: ${j.email} (id: ${userId})`;
}

async function wallet() {
  if (!userId) return alert('Faça login');
  const r = await fetch(`${API}/wallet/${userId}`);
  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Erro ao buscar carteira');
  document.getElementById('wallet').innerText = `Saldo: R$ ${j.balance.toFixed(2)} | Em processamento: R$ ${j.hold.toFixed(2)}`;
}

async function deposit() {
  if (!userId) return alert('Faça login');
  const reais = Number(document.getElementById('depAmount').value);
  if (!reais || reais <= 5) return alert('O valor mínimo para depósito é R$ 6,00');

  const r = await fetch(`${API}/deposit`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ email: userEmail, amount: reais, currency: 'BRL' })
  });

  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Erro no depósito');

  let html = `<p><b>Status:</b> ${j.status || 'pending'}</p>`;

  if (j.pixQrCode) {
    html += `<p><img src="${j.pixQrCode}" alt="QR Pix" style="max-width:200px"></p>`;
  }
  if (j.qr_code_base64) {
    html += `<p><img src="data:image/png;base64,${j.qr_code_base64}" alt="QR Pix" style="max-width:200px"></p>`;
  }
  if (j.pixCopiaCola) {
    html += `
      <p><b>Copia e Cola:</b></p>
      <textarea id="copiaCola" readonly style="width:100%;height:80px">${j.pixCopiaCola}</textarea>
      <button onclick="copyCopiaCola()">Copiar código</button>
    `;
  }
  if (j.checkoutUrl) {
    html += `<p><a href="${j.checkoutUrl}" target="_blank">Abrir checkout</a></p>`;
  }

  document.getElementById('dep').innerHTML = html;
}

function copyCopiaCola() {
  const textarea = document.getElementById('copiaCola');
  textarea.select();
  textarea.setSelectionRange(0, 99999);
  document.execCommand('copy');
  alert('Código Pix copiado!');
}

async function withdraw() {
  if (!userId) return alert('Faça login');
  const reais = Number(document.getElementById('saqAmount').value);
  const pixType = document.getElementById('pixType').value;
  const pixKey = document.getElementById('pixKey').value.trim();

  if (!reais || reais < 10) return alert('O valor mínimo para saque é R$ 10,00');
  if (!pixKey) return alert('Informe a chave Pix');

  const r = await fetch(`${API}/payout`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      email: userEmail,
      amount: reais,
      currency: 'BRL',
      destination: { type: pixType, key: pixKey }
    })
  });

  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Erro no saque');
  document.getElementById('saq').innerText = `Payout: ${j.gateway_id || ''} (${j.status})`;
}

    async function bet() {
  if (!userId) return alert('Faça login');
  const reais = Number(document.getElementById('betAmount').value);
  const betType = document.getElementById('betType').value;
  const betValue = document.getElementById('betValue').value.trim();

  if (!reais || reais <= 0) return alert('Informe um valor válido para aposta');

  const r = await fetch(`${API}/bet`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ userId, amount: reais, betType, betValue })
  });

  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Erro na aposta');

  document.getElementById('bet').innerText =
    `Número sorteado: ${j.outcome} | Ganhou: R$ ${j.win.toFixed(2)} | Saldo final: R$ ${j.finalBalance.toFixed(2)}`;
}

async function loadTransactions() {
  if (!userId) return alert('Faça login');
  const r = await fetch(`${API}/transactions/${userId}?limit=10`);
  const j = await r.json();
  if (!r.ok) return alert(j.error || 'Erro ao buscar histórico');

  const rows = j.items.map(tx => `
    <tr>
      <td>${new Date(tx.created_at).toLocaleString('pt-BR')}</td>
      <td>${tx.type}</td>
      <td>R$ ${(tx.amount/100).toFixed(2)}</td>
      <td>R$ ${(tx.balance_after/100).toFixed(2)}</td>
    </tr>
  `).join('');

  document.getElementById('txBody').innerHTML =
    rows || '<tr><td colspan="4">Sem transações</td></tr>';
}
</script>
</body>
</html>
